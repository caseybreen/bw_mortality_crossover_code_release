---
title: "Black-White Crossover, extinct cohort method with uncertainty"
author: Casey Breen
---

Summary: Calculate Black-White crossover with uncertainty using extinct cohort method 

```{r}
## Library packages 
library(here)
source(here("code", "helpers.R"))

## Read in dmf 
dmf <- fread(here("data/censoc_dmf_v2_1_linked_with_census.csv"))

## Recode race 
## Restrict to conservative matches 
## Restrict to people born in the US 
dmf <- dmf %>%
  janitor::clean_names() %>%
  mutate(race = case_when(
    race == 100 ~ "White Americans",
    race == 200 ~ "Black Americans"
  )) %>%
  filter(link_abe_exact_conservative == 1) %>%
  filter(bpl < 15000)

## Restrict to ages 
dmf_filter <- dmf %>% 
  filter(byear %in% c(1895:1905)) 
```



```{r}
## Function to calculate qx that can be bootstrapped 
## All cells have at least one death for 1975-2005  
calculate_ln_qx <- function(data) {
  data %>%
    group_by(byear, death_age, race) %>%
    summarize(deaths = n(), .groups = "drop") %>%
    arrange(race, byear, death_age) %>%  ## data organized for cumsum which comes later
    group_by(race, byear) %>%
    mutate(
      lx = sum(deaths) - lag(cumsum(deaths), default = 0),
      qx = deaths / lx,
      ln_qx = log(qx) ## this will give infinity unless there is at least one death per cell (!)
    ) %>%
    ungroup()
} 

ln_qx_point_estimate <- dmf_filter %>% 
  calculate_ln_qx() %>% 
  group_by(death_age, race) %>%
  summarize(ln_qx_point_estimate = mean(ln_qx, na.rm = TRUE))

# Bootstrap and average hazards across byear within each bootstrap
boot_df_1 <- replicate(100, {
  dmf_filter %>%
    sample_frac(replace = TRUE) %>%
    calculate_ln_qx() %>%
    group_by(death_age, race) %>%
    summarize(ln_qx = mean(ln_qx, na.rm = TRUE), .groups = "drop")
}, simplify = FALSE) %>%
  bind_rows(.id = "bootstrap_id")

# Summarize hazards across bootstraps
ln_qx_uncertainty <- boot_df_1 %>%
  group_by(death_age, race) %>%
  summarize(
    mean_hazard = mean(ln_qx, na.rm = TRUE),
    lower_ci = quantile(ln_qx, 0.025, na.rm = TRUE),
    upper_ci = quantile(ln_qx, 0.975, na.rm = TRUE),
    .groups = "drop"
  ) 

ln_qx_uncertainty_point_estimate <- ln_qx_uncertainty %>% 
  left_join(ln_qx_point_estimate, by = c("death_age", "race"))

# Plot
pooled_bwcrossover <- ln_qx_uncertainty_point_estimate %>%
  filter(death_age %in% 75:100, race %in% c("White Americans", "Black Americans")) %>%
  ggplot(aes(x = death_age, y = ln_qx_point_estimate, color = race)) +
  geom_line() +
  geom_pointrange(aes(ymin = lower_ci, ymax = upper_ci, shape = race), size = 0.75, fill = "white") +
  geom_vline(xintercept = 86, linetype = "dashed") +
  theme_cowplot() +
  ggsci::scale_colour_lancet() +
  scale_shape_manual(values = c(21, 24)) +
  labs(
    x = "Age",
    y = "Probability of death (Log Scale)",
    title = "Mortality Crossovers (Men)",
    subtitle = "Pooled cohorts of 1890-1905"
  ) +
  theme(
    legend.position = c(0.999, 0.001),
    legend.justification = c("right", "bottom"),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6),
    legend.background = element_rect(color = "black", size = 0.5, linetype = "solid"),
    legend.title = element_blank()
  )

# Save plots
ggsave(plot = pooled_bwcrossover, filename = here("figures/bw_crossover_1890_1905.png"), width = 7.5, height = 5, bg = "white")
```






